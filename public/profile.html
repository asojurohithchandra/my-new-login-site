<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Profile – Project R</title>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: #f4f5fb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    .card {
      background: #ffffff;
      width: 380px;
      max-width: 100%;
      border-radius: 16px;
      padding: 22px 22px 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.14);
    }

    h2 {
      margin: 0 0 6px;
      font-size: 22px;
      font-weight: 600;
    }

    .subtitle {
      margin-bottom: 16px;
      font-size: 13px;
      color: #6b7280;
    }

    .field-group {
      margin-bottom: 12px;
    }

    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 13px;
      color: #4b5563;
    }

    .label-row span.secondary {
      font-size: 11px;
      color: #9ca3af;
    }

    input[type="text"],
    input[type="email"],
    input[type="date"],
    select {
      width: 100%;
      padding: 9px 10px;
      border-radius: 9px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    input:focus,
    select:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.12);
    }

    input[readonly] {
      background: #f9fafb;
      color: #6b7280;
    }

    .row-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .helper {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .section-title {
      margin-top: 12px;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 600;
      color: #4b5563;
    }

    .password-note {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .primary-btn {
      width: 100%;
      padding: 10px 0;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #f9fafb;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 4px;
      transition: background 0.15s ease, box-shadow 0.12s ease, transform 0.08s ease;
    }

    .primary-btn:hover {
      background: #16a34a;
      box-shadow: 0 10px 22px rgba(22, 163, 74, 0.32);
      transform: translateY(-1px);
    }

    .status {
      margin-top: 8px;
      font-size: 12px;
      min-height: 16px;
    }

    .status.ok {
      color: #16a34a;
    }

    .status.err {
      color: #dc2626;
    }

    .small-link {
      margin-top: 8px;
      font-size: 12px;
      text-align: center;
      color: #4b5563;
    }

    .small-link a {
      color: #4f46e5;
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }

    .small-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Your Profile</h2>
    <div class="subtitle">
      We’ll use this info to personalize reviews for you.
    </div>

    <!-- Email (from login) -->
    <div class="field-group">
      <div class="label-row">
        <span>Email</span>
        <span class="secondary">Used as your login</span>
      </div>
      <input type="email" id="email" readonly />
    </div>

    <!-- Display + Full name -->
    <div class="row-2 field-group">
      <div>
        <div class="label-row">
          <span>Display name</span>
        </div>
        <input type="text" id="displayName" placeholder="@rohith" />
      </div>
      <div>
        <div class="label-row">
          <span>Full name</span>
        </div>
        <input type="text" id="fullName" placeholder="Rohith Chandra" />
      </div>
    </div>

    <!-- DOB + Gender -->
    <div class="row-2 field-group">
      <div>
        <div class="label-row">
          <span>Date of birth</span>
        </div>
        <input type="date" id="dob" />
      </div>
      <div>
        <div class="label-row">
          <span>How do you identify?</span>
        </div>
        <select id="gender">
          <option value="unspecified">Prefer not to say</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="nonbinary">Non-binary</option>
        </select>
      </div>
    </div>

    <!-- Profession / company / university -->
    <div class="row-2 field-group">
      <div>
        <div class="label-row">
          <span>Profession</span>
        </div>
        <select id="profession">
          <option value="">Select…</option>
          <option value="student">Student</option>
          <option value="working">Working professional</option>
          <option value="business">Business owner</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div>
        <div class="label-row">
          <span>Company</span>
        </div>
        <input type="text" id="company" placeholder="NetApp" />
      </div>
    </div>

    <div class="field-group">
      <div class="label-row">
        <span>University</span>
      </div>
      <input type="text" id="university" placeholder="USC, UT Dallas, etc." />
      <div class="helper">Optional, but helps us show relevant reviews.</div>
    </div>

    <!-- Password section -->
    <div class="section-title">Change password (optional)</div>
    <div class="password-note">
      Leave these blank if you don’t want to change your password.
    </div>

    <div class="field-group">
      <div class="label-row">
        <span>Current password</span>
      </div>
      <input type="password" id="currentPassword" placeholder="Current password" />
    </div>

    <div class="row-2 field-group">
      <div>
        <div class="label-row">
          <span>New password</span>
        </div>
        <input type="password" id="newPassword" placeholder="New password" />
      </div>
      <div>
        <div class="label-row">
          <span>Confirm new</span>
        </div>
        <input type="password" id="confirmPassword" placeholder="Repeat new password" />
      </div>
    </div>

    <button class="primary-btn" onclick="saveAndContinue()">Save & go to main page</button>

    <div id="status" class="status"></div>

    <div class="small-link">
      Want to skip for now? <a onclick="goToMain()">Go to main page</a>
    </div>
  </div>

  <script>
    let emailFromQuery = "";

    // Load email from query and prefill profile
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      emailFromQuery = params.get("email") || "";
      const emailInput = document.getElementById("email");

      if (emailFromQuery) {
        emailInput.value = emailFromQuery;
        fetchProfile(emailFromQuery);
      } else {
        emailInput.value = "";
        setStatus("Missing email in URL. Please log in again.", true);
      }
    });

    function setStatus(msg, isError = false) {
      const el = document.getElementById("status");
      el.textContent = msg || "";
      el.className = "status " + (isError ? "err" : "ok");
    }

    async function fetchProfile(username) {
      try {
        const res = await fetch("/api/profile?username=" + encodeURIComponent(username));
        if (!res.ok) {
          // 404 means new user — no prefill, just return silently
          return;
        }
        const data = await res.json();
        if (!data.success || !data.profile) return;

        const p = data.profile;
        document.getElementById("displayName").value = p.displayName || "";
        document.getElementById("fullName").value = p.fullName || "";
        document.getElementById("dob").value = p.dateOfBirth || "";
        document.getElementById("gender").value = p.gender || "unspecified";
        document.getElementById("company").value = p.company || "";
        document.getElementById("university").value = p.university || "";
        document.getElementById("profession").value = p.profession || "";
      } catch (err) {
        console.error("Profile fetch error", err);
        setStatus("Could not load profile. You can still edit and save.", true);
      }
    }

    function goToMain() {
      if (!emailFromQuery) {
        window.location.href = "dashboard.html";
        return;
      }
      window.location.href =
        "dashboard.html?email=" + encodeURIComponent(emailFromQuery);
    }

    async function saveAndContinue() {
      setStatus("");
      const email = document.getElementById("email").value.trim();
      const displayName = document.getElementById("displayName").value.trim();
      const fullName = document.getElementById("fullName").value.trim();
      const dateOfBirth = document.getElementById("dob").value;
      const gender = document.getElementById("gender").value;
      const profession = document.getElementById("profession").value;
      const company = document.getElementById("company").value.trim();
      const university = document.getElementById("university").value.trim();

      const currentPassword = document
        .getElementById("currentPassword")
        .value.trim();
      const newPassword = document.getElementById("newPassword").value.trim();
      const confirmPassword = document
        .getElementById("confirmPassword")
        .value.trim();

      if (!email) {
        setStatus("Missing email. Please log in again.", true);
        return;
      }

      // Basic validation
      if (!fullName) {
        setStatus("Please enter your full name.", true);
        return;
      }

      if (newPassword || confirmPassword || currentPassword) {
        // If user wants to change password, all three must be filled
        if (!currentPassword || !newPassword || !confirmPassword) {
          setStatus("To change password, fill all three fields.", true);
          return;
        }
        if (newPassword !== confirmPassword) {
          setStatus("New passwords do not match.", true);
          return;
        }
      }

      // 1) Save profile
      try {
        const res = await fetch("/api/profile", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username: email,
            displayName,
            fullName,
            dateOfBirth,
            gender,
            avatarType: gender, // for now avatar follows gender
            company,
            university,
            profession
          })
        });

        const data = await res.json();
        if (!data.success) {
          setStatus(data.message || "Failed to save profile.", true);
          return;
        }
      } catch (err) {
        console.error("Profile save error", err);
        setStatus("Server error saving profile.", true);
        return;
      }

      // 2) Optionally change password
      if (currentPassword && newPassword && confirmPassword) {
        try {
          const resPw = await fetch("/api/change-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: email,
              currentPassword,
              newPassword
            })
          });
          const pwData = await resPw.json();
          if (!pwData.success) {
            setStatus(pwData.message || "Password change failed.", true);
            return;
          }
        } catch (err) {
          console.error("Password change error", err);
          setStatus("Server error changing password.", true);
          return;
        }
      }

      // 3) All good → go to main page
      setStatus("Profile saved. Redirecting…", false);
      goToMain();
    }
  </script>
</body>
</html>
