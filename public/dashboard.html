<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project R ‚Äì Dashboard</title>

  <style>
    :root {
      --bg-main: #f4f5fb;
      --accent-soft: #fef9c3;
      --accent: #a3e635;
      --accent-strong: #84cc16;
      --text-main: #111827;
      --text-muted: #6b7280;
      --nav-bg: #111827;
      --border-subtle: #e5e7eb;
      --card-radius: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
    }

    .app {
      display: grid;
      grid-template-columns: 230px minmax(0, 1.6fr) minmax(260px, 0.9fr);
      min-height: 100vh;
    }

    @media (max-width: 960px) {
      .app {
        grid-template-columns: 70px minmax(0, 1fr);
        grid-template-rows: auto auto;
      }
      .right-panel {
        display: none;
      }
    }

    @media (max-width: 720px) {
      .app {
        grid-template-columns: 1fr;
      }
      .sidebar {
        display: none;
      }
    }

    /* Sidebar */

    .sidebar {
      background: var(--nav-bg);
      color: #e5e7eb;
      padding: 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .logo {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #f9fafb;
      padding: 6px 4px;
    }

    .nav {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      color: #e5e7eb;
      border: none;
      background: transparent;
      text-align: left;
    }

    .nav-item span.icon {
      width: 20px;
      text-align: center;
      font-size: 14px;
    }

    .nav-item.active {
      background: #facc15;
      color: #111827;
      font-weight: 600;
    }

    .nav-item:hover:not(.active) {
      background: rgba(249, 250, 251, 0.07);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 11px;
      color: #9ca3af;
      padding: 0 4px;
    }

    /* Main */

    .main {
      padding: 16px 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      background: linear-gradient(135deg, #fefce8 0%, #f4f5fb 40%, #eef2ff 100%);
      border-right: 1px solid var(--border-subtle);
    }

    .top-bar {
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
    }

    .top-bar-row {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .top-logo-mobile {
      display: none;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #4b5563;
    }

    @media (max-width: 720px) {
      .top-logo-mobile {
        display: block;
      }
    }

    .search-wrapper {
      flex: 1;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 9px 38px 9px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: rgba(249, 250, 251, 0.9);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .search-input:focus {
      border-color: #4f46e5;
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.1);
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 15px;
      color: #9ca3af;
    }

    .search-status {
      font-size: 12px;
      color: var(--text-muted);
      padding-left: 4px;
    }

    .search-status.valid {
      color: #15803d;
    }

    .search-status.new {
      color: #a16207;
    }

    .suggestions {
      position: absolute;
      top: 38px;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid rgba(209, 213, 219, 0.7);
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.18);
      max-height: 260px;
      overflow-y: auto;
      z-index: 10;
      font-size: 13px;
    }

    .suggestion-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 7px 11px;
      cursor: pointer;
    }

    .suggestion-item:not(:last-child) {
      border-bottom: 1px solid #f3f4f6;
    }

    .suggestion-item:hover {
      background: #f9fafb;
    }

    .suggestion-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .suggestion-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .suggestion-icon {
      font-size: 13px;
    }

    .suggestion-create {
      background: #fefce8;
    }

    /* Subject view / feed */

    .feed {
      margin-top: 8px;
    }

    .feed-placeholder {
      padding: 14px 16px;
      border-radius: var(--card-radius);
      background: rgba(255, 255, 255, 0.9);
      border: 1px dashed rgba(148, 163, 184, 0.7);
      font-size: 13px;
      color: #6b7280;
    }

    .subject-card {
      background: #ffffff;
      border-radius: var(--card-radius);
      padding: 16px 18px 14px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.15);
      border: 1px solid rgba(209, 213, 219, 0.8);
      margin-bottom: 14px;
    }

    .subject-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

    .subject-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .subject-name {
      font-size: 20px;
      font-weight: 700;
    }

    .subject-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #6b7280;
    }

    .badge-verified {
      padding: 3px 8px;
      border-radius: 999px;
      background: #ecfdf3;
      color: #16a34a;
      font-weight: 500;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-unverified {
      padding: 3px 8px;
      border-radius: 999px;
      background: #fef3c7;
      color: #92400e;
      font-weight: 500;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .subject-stars {
      color: #fbbf24;
      font-size: 18px;
    }

    .validation-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .btn-validate {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #f59e0b;
      background: #fef3c7;
      color: #92400e;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-validate:hover {
      background: #fbbf24;
      color: #78350f;
    }

    .validation-msg {
      font-size: 11px;
      color: #6b7280;
      max-width: 180px;
      text-align: right;
    }

    /* Reviews list */

    .reviews-section-title {
      font-size: 13px;
      font-weight: 600;
      margin: 4px 2px 8px;
      color: #4b5563;
    }

    .review-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .review-card {
      padding: 10px 12px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .review-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 11px;
      color: #6b7280;
    }

    .review-stars {
      color: #fbbf24;
      font-size: 13px;
      display: inline-flex;
      gap: 1px;
    }

    .review-stars .star.small {
      font-size: 13px;
      color: #d1d5db;
    }

    .review-stars .star.small.filled {
      color: #fbbf24;
    }

    .review-text {
      font-size: 13px;
      color: #111827;
      line-height: 1.4;
    }

    .review-empty {
      font-size: 12px;
      color: #9ca3af;
      padding: 6px 2px 10px;
    }

    /* Write review */

    .write-review-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
      margin: 4px 0 6px;
    }

    .write-review-toggle:hover {
      background: #111827;
      color: #f9fafb;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.25);
    }

    .write-review-card {
      margin-top: 4px;
      padding: 16px 18px 14px;
      border-radius: 18px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.15);
      display: none;
    }

    .write-stars-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    #starContainer {
      display: inline-flex;
      gap: 4px;
    }

    .star {
      font-size: 22px;
      color: #d1d5db;
      cursor: pointer;
      transition: color 0.1s ease, transform 0.1s ease;
    }

    .star.filled {
      color: #fbbf24;
    }

    .star:hover {
      transform: translateY(-1px);
    }

    .rating-value {
      font-size: 13px;
      color: #4b5563;
      font-weight: 500;
    }

    .rating-slider-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }

    .rating-slider {
      width: 180px;
    }

    .write-textarea-wrapper {
      background: #f5f5f6;
      border-radius: 18px;
      padding: 14px 18px 10px;
      margin-bottom: 8px;
    }

    .write-textarea {
      width: 100%;
      border: none;
      resize: vertical;
      min-height: 90px;
      max-height: 220px;
      outline: none;
      font-family: inherit;
      font-size: 14px;
      color: #111827;
      background: transparent;
    }

    .write-toolbar-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
    }

    .write-toolbar {
      display: flex;
      gap: 10px;
      font-size: 13px;
      color: #9ca3af;
    }

    .write-toolbar span {
      cursor: pointer;
      user-select: none;
    }

    .write-toolbar span:hover {
      color: #4b5563;
    }

    .write-post-btn {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      background: #38bdf8;
      color: #ffffff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(56, 189, 248, 0.45);
    }

    .write-post-btn:hover {
      background: #0284c7;
    }

    .write-error {
      font-size: 12px;
      color: #b91c1c;
      margin-top: 6px;
    }

    /* Right panel */

    .right-panel {
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #f9fafb;
    }

    .profile-card {
      background: #ffffff;
      border-radius: var(--card-radius);
      padding: 14px 14px 12px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.1);
      border: 1px solid rgba(209, 213, 219, 0.8);
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: #f97316;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-size: 17px;
      font-weight: 600;
    }

    .profile-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .profile-name {
      font-size: 14px;
      font-weight: 600;
    }

    .profile-email {
      font-size: 12px;
      color: #6b7280;
      word-break: break-all;
    }

    .profile-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }

    .btn-outline,
    .btn-danger {
      width: 100%;
      padding: 7px 0;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #111827;
      font-weight: 500;
      transition: background 0.15s ease, color 0.15s ease, box-shadow 0.12s ease;
    }

    .btn-outline:hover {
      background: #111827;
      color: #f9fafb;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.4);
    }

    .btn-danger {
      border-color: #fecaca;
      background: #fef2f2;
      color: #b91c1c;
    }

    .btn-danger:hover {
      background: #b91c1c;
      color: white;
      box-shadow: 0 8px 18px rgba(185, 28, 28, 0.45);
    }

    .right-caption {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT SIDEBAR -->
    <aside class="sidebar">
      <div class="logo">Project R</div>
      <nav class="nav">
        <button class="nav-item active">
          <span class="icon">üè†</span>
          <span>Home</span>
        </button>
        <button class="nav-item">
          <span class="icon">üî•</span>
          <span>Trendy</span>
        </button>
        <button class="nav-item">
          <span class="icon">üïí</span>
          <span>Latest</span>
        </button>
        <button class="nav-item">
          <span class="icon">üîî</span>
          <span>Notifications</span>
        </button>
        <button class="nav-item">
          <span class="icon">üíæ</span>
          <span>Saved posts</span>
        </button>
      </nav>

      <div class="sidebar-footer">
        Project R ¬∑ Early prototype<br />
        Search a subject to get started.
      </div>
    </aside>

    <!-- MAIN COLUMN -->
    <main class="main">
      <!-- Top search for subjects -->
      <header class="top-bar">
        <div class="top-bar-row">
          <div class="top-logo-mobile">Project R</div>
          <div class="search-wrapper">
            <input
              id="searchInput"
              class="search-input"
              type="text"
              placeholder="Search subjects (e.g., USC, Stanford, UT Austin)..."
              autocomplete="off"
            />
            <span class="search-icon">üîç</span>
            <div id="suggestions" class="suggestions" style="display:none;"></div>
          </div>
        </div>
        <div id="searchStatus" class="search-status">
          Type to search known subjects. Valid subjects have a ‚úì. You can also create a new subject.
        </div>
      </header>

      <!-- Subject / feed area -->
      <section class="feed">
        <div id="feedContent" class="feed-placeholder">
          After you pick a subject, its review page will appear here. For valid subjects you‚Äôll see a verified badge; new
          subjects can be submitted for validation and reviewed.
        </div>
      </section>
    </main>

    <!-- RIGHT PROFILE PANEL -->
    <aside class="right-panel">
      <div class="profile-card">
        <div class="profile-header">
          <div id="avatar" class="avatar">R</div>
          <div class="profile-main">
            <div id="profileName" class="profile-name">New reviewer</div>
            <div id="profileEmail" class="profile-email">you@example.com</div>
          </div>
        </div>

        <div class="profile-actions">
          <button class="btn-outline" onclick="goToProfile()">Go to profile</button>
          <button class="btn-danger" onclick="logout()">Log out</button>
        </div>

        <div class="right-caption">
          In later versions we‚Äôll show your stats here ‚Äì subjects reviewed, upvotes and saved posts.
        </div>
      </div>
    </aside>
  </div>

  <script>
    // Top 30 universities as valid subjects
    const SUBJECTS = [
      "Harvard University",
      "Stanford University",
      "Massachusetts Institute of Technology",
      "University of California, Berkeley",
      "University of Oxford",
      "University of Cambridge",
      "California Institute of Technology",
      "Princeton University",
      "Yale University",
      "Columbia University",
      "University of Chicago",
      "University of Pennsylvania",
      "Cornell University",
      "University of California, Los Angeles",
      "University of Michigan ‚Äì Ann Arbor",
      "New York University",
      "University of Texas at Austin",
      "Carnegie Mellon University",
      "Duke University",
      "Northwestern University",
      "University of Washington",
      "University of Southern California",
      "Georgia Institute of Technology",
      "University of Illinois Urbana-Champaign",
      "University of Toronto",
      "ETH Zurich",
      "National University of Singapore",
      "University of British Columbia",
      "London School of Economics",
      "University College London"
    ];

    let currentEmail = "";
    let currentSubject = "";
    let currentSubjectIsValid = false;
    let currentRating = 5.0;

    // local in-memory reviews: { [subjectName]: [{text, rating, createdAt}] }
    const localReviews = {};

    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      currentEmail = params.get("email") || "";

      const emailEl = document.getElementById("profileEmail");
      const nameEl = document.getElementById("profileName");
      const avatarEl = document.getElementById("avatar");

      if (currentEmail) {
        emailEl.textContent = currentEmail;
        const namePart = currentEmail.split("@")[0];
        nameEl.textContent = namePart || "Reviewer";
        avatarEl.textContent = (namePart || "R").charAt(0).toUpperCase();
      } else {
        emailEl.textContent = "Not signed in correctly";
        nameEl.textContent = "Guest";
        avatarEl.textContent = "G";
      }

      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("input", handleSearchInput);
      searchInput.addEventListener("focus", handleSearchInput);

      document.addEventListener("click", (e) => {
        const wrapper = document.querySelector(".search-wrapper");
        const suggestions = document.getElementById("suggestions");
        if (!wrapper.contains(e.target)) {
          suggestions.style.display = "none";
        }
      });
    });

    function normalize(str) {
      return str.trim().toLowerCase();
    }

    function handleSearchInput() {
      const inputEl = document.getElementById("searchInput");
      const query = inputEl.value;
      const suggestionsEl = document.getElementById("suggestions");
      const statusEl = document.getElementById("searchStatus");

      const trimmed = query.trim();
      const norm = normalize(trimmed);

      if (!trimmed) {
        suggestionsEl.style.display = "none";
        suggestionsEl.innerHTML = "";
        statusEl.textContent =
          "Type to search known subjects. Valid subjects have a ‚úì. You can also create a new subject.";
        statusEl.className = "search-status";
        return;
      }

      const matches = SUBJECTS.filter((s) => normalize(s).includes(norm));
      const exact = SUBJECTS.find((s) => normalize(s) === norm);

      if (exact) {
        statusEl.textContent = `Valid subject ‚úì "${exact}"`;
        statusEl.className = "search-status valid";
      } else {
        statusEl.textContent = `New subject ‚Äì not in list yet. You can create it.`;
        statusEl.className = "search-status new";
      }

      suggestionsEl.innerHTML = "";

      matches.slice(0, 8).forEach((subj) => {
        const item = document.createElement("div");
        item.className = "suggestion-item";
        item.onclick = () => selectSubject(subj, true);

        const label = document.createElement("div");
        label.className = "suggestion-label";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = subj;

        const tag = document.createElement("span");
        tag.className = "suggestion-tag";
        tag.textContent = "valid";

        label.appendChild(nameSpan);
        label.appendChild(tag);

        const icon = document.createElement("span");
        icon.className = "suggestion-icon";
        icon.textContent = "‚úì";

        item.appendChild(label);
        item.appendChild(icon);
        suggestionsEl.appendChild(item);
      });

      if (!exact) {
        const createItem = document.createElement("div");
        createItem.className = "suggestion-item suggestion-create";
        createItem.onclick = () => selectSubject(trimmed, false);

        const label = document.createElement("div");
        label.className = "suggestion-label";

        const textSpan = document.createElement("span");
        textSpan.textContent = `Create new subject: "${trimmed}"`;

        label.appendChild(textSpan);

        const icon = document.createElement("span");
        icon.className = "suggestion-icon";
        icon.textContent = "‚ûï";

        createItem.appendChild(label);
        createItem.appendChild(icon);
        suggestionsEl.appendChild(createItem);
      }

      suggestionsEl.style.display = "block";
    }

    function selectSubject(name, isValid) {
      currentSubject = name;
      currentSubjectIsValid = isValid;

      const input = document.getElementById("searchInput");
      const suggestionsEl = document.getElementById("suggestions");
      const statusEl = document.getElementById("searchStatus");

      input.value = name;
      suggestionsEl.style.display = "none";

      if (isValid) {
        statusEl.textContent = `Valid subject ‚úì "${name}" selected.`;
        statusEl.className = "search-status valid";
      } else {
        statusEl.textContent =
          `New subject "${name}" created locally. Submit for validation if this is a real subject.`;
        statusEl.className = "search-status new";
      }

      renderSubjectView();
    }

    function renderSubjectView() {
      const container = document.getElementById("feedContent");
      if (!currentSubject) {
        container.className = "feed-placeholder";
        container.textContent =
          "After you pick a subject, its review page will appear here.";
        return;
      }

      const reviews = localReviews[currentSubject] || [];

      container.className = "";
      container.innerHTML = `
        <div class="subject-card">
          <div class="subject-header-row">
            <div class="subject-title-block">
              <div class="subject-name">${currentSubject}</div>
              <div class="subject-meta">
                ${
                  currentSubjectIsValid
                    ? '<span class="badge-verified">‚úì Verified subject</span>'
                    : '<span class="badge-unverified">Unverified subject</span>'
                }
                <span>Early prototype ratings</span>
              </div>
            </div>
            <div class="validation-actions">
              <div class="subject-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
              ${
                currentSubjectIsValid
                  ? '<div class="validation-msg">From our initial curated list of universities.</div>'
                  : `<button id="validationButton" class="btn-validate">
                       Submit for validation
                     </button>
                     <div id="validationMsg" class="validation-msg">
                       Not yet approved. Tell us this is a real subject.
                     </div>`
              }
            </div>
          </div>

          <div class="reviews-section-title">Reviews</div>
          <div class="review-list" id="reviewList">
            ${
              reviews.length === 0
                ? '<div class="review-empty">No reviews for this subject yet. Be the first to write one.</div>'
                : reviews
                    .map(
                      (r) => `
                <article class="review-card">
                  <div class="review-card-header">
                    <span class="review-stars">${renderStarsHTML(r.rating)}</span>
                    <span class="review-time">${r.createdAt} ¬∑ ${r.rating.toFixed(1)} / 5.0</span>
                  </div>
                  <div class="review-text">${escapeHtml(r.text)}</div>
                </article>`
                    )
                    .join("")
            }
          </div>

          <button id="writeReviewToggle" class="write-review-toggle">
            <span>‚úèÔ∏è</span><span>Write a review</span>
          </button>

          <div id="writeReviewCard" class="write-review-card">
            <div class="write-stars-row">
              <div id="starContainer">
                <span class="star" data-star="1">‚òÖ</span>
                <span class="star" data-star="2">‚òÖ</span>
                <span class="star" data-star="3">‚òÖ</span>
                <span class="star" data-star="4">‚òÖ</span>
                <span class="star" data-star="5">‚òÖ</span>
              </div>
              <span id="ratingValueText" class="rating-value">5.0 / 5.0</span>
            </div>
            <div class="rating-slider-wrapper">
              <input id="ratingSlider" class="rating-slider" type="range" min="1" max="5" step="0.1" value="5" />
            </div>

            <div class="write-textarea-wrapper">
              <textarea id="reviewText" class="write-textarea" placeholder="Type your Review..."></textarea>
              <div class="write-toolbar-row">
                <div class="write-toolbar">
                  <span data-action="bold"><b>B</b></span>
                  <span data-action="italic"><i>i</i></span>
                  <span data-action="link">üîó</span>
                  <span data-action="bullet">‚Ä¢</span>
                  <span data-action="number">1.</span>
                </div>
                <button id="writeReviewPost" class="write-post-btn">Post</button>
              </div>
              <div id="writeError" class="write-error"></div>
            </div>
          </div>
        </div>
      ";

      // attach listeners for the newly created elements
      const toggleBtn = document.getElementById("writeReviewToggle");
      const card = document.getElementById("writeReviewCard");
      const postBtn = document.getElementById("writeReviewPost");
      const validationBtn = document.getElementById("validationButton");

      if (toggleBtn && card) {
        toggleBtn.addEventListener("click", () => {
          card.style.display = card.style.display === "block" ? "none" : "block";
        });
      }

      if (postBtn) {
        postBtn.addEventListener("click", handlePostReview);
      }

      if (validationBtn) {
        validationBtn.addEventListener("click", handleValidationSubmit);
      }

      initRatingControls();
      initToolbar();
    }

    function initRatingControls() {
      const stars = Array.from(document.querySelectorAll("#starContainer .star"));
      const slider = document.getElementById("ratingSlider");
      const valueText = document.getElementById("ratingValueText");
      if (!stars.length || !slider || !valueText) return;

      function apply(r) {
        currentRating = Math.min(5, Math.max(1, r));
        updateStarsDisplay(stars, currentRating);
        valueText.textContent = currentRating.toFixed(1) + " / 5.0";
        slider.value = String(currentRating);
      }

      stars.forEach((star, idx) => {
        const starValue = idx + 1;
        star.addEventListener("mouseenter", () => {
          updateStarsDisplay(stars, starValue);
          valueText.textContent = starValue.toFixed(1) + " / 5.0";
        });
        star.addEventListener("click", () => apply(starValue));
      });

      const starContainer = document.getElementById("starContainer");
      starContainer.addEventListener("mouseleave", () => {
        apply(currentRating);
      });

      slider.addEventListener("input", (e) => {
        const value = parseFloat(e.target.value);
        apply(value);
      });

      apply(5.0);
    }

    function updateStarsDisplay(stars, rating) {
      const full = Math.floor(rating);
      const hasHalf = rating - full >= 0.5;
      stars.forEach((star, index) => {
        if (index < full) {
          star.className = "star filled";
        } else if (index === full && hasHalf) {
          star.className = "star filled";
        } else {
          star.className = "star";
        }
      });
    }

    function handlePostReview() {
      const textEl = document.getElementById("reviewText");
      const errorEl = document.getElementById("writeError");
      const text = (textEl.value || "").trim();

      if (!text) {
        errorEl.textContent = "Please write something before posting.";
        return;
      }

      errorEl.textContent = "";

      if (!localReviews[currentSubject]) {
        localReviews[currentSubject] = [];
      }

      const now = new Date();
      const timeLabel = now.toLocaleString(undefined, {
        hour: "2-digit",
        minute: "2-digit",
        month: "short",
        day: "numeric"
      });

      localReviews[currentSubject].unshift({
        text,
        rating: currentRating,
        createdAt: `Just now ¬∑ ${timeLabel}`
      });

      textEl.value = "";
      renderSubjectView();
      const card = document.getElementById("writeReviewCard");
      if (card) card.style.display = "block";
    }

    function handleValidationSubmit() {
      const btn = document.getElementById("validationButton");
      const msg = document.getElementById("validationMsg");
      if (btn) {
        btn.disabled = true;
        btn.textContent = "Submitted";
      }
      if (msg) {
        msg.textContent = "This subject has been submitted to the admin for validation.";
      }
    }

    function renderStarsHTML(rating) {
      const full = Math.floor(rating);
      const hasHalf = rating - full >= 0.5;
      let html = "";
      for (let i = 0; i < 5; i++) {
        if (i < full) {
          html += '<span class="star small filled">‚òÖ</span>';
        } else if (i === full && hasHalf) {
          html += '<span class="star small filled">‚òÖ</span>';
        } else {
          html += '<span class="star small">‚òÖ</span>';
        }
      }
      return html;
    }

    function initToolbar() {
      const buttons = document.querySelectorAll(".write-toolbar span[data-action]");
      const textarea = document.getElementById("reviewText");
      if (!buttons.length || !textarea) return;

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          applyToolbarAction(textarea, btn.dataset.action);
        });
      });
    }

    function applyToolbarAction(textarea, action) {
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const value = textarea.value;
      const selected = value.slice(start, end);

      function replace(newText) {
        textarea.value = value.slice(0, start) + newText + value.slice(end);
        textarea.focus();
        textarea.selectionStart = start;
        textarea.selectionEnd = start + newText.length;
      }

      if (action === "bold") {
        replace(`**${selected || "bold text"}**`);
      } else if (action === "italic") {
        replace(`*${selected || "italic text"}*`);
      } else if (action === "link") {
        const url = prompt("Enter URL:", "https://");
        if (!url) return;
        const label = selected || "link text";
        replace(`[${label}](${url})`);
      } else if (action === "bullet") {
        const lines = (selected || "bullet item")
          .split("\n")
          .map((l) => (l ? "- " + l : l))
          .join("\n");
        replace(lines);
      } else if (action === "number") {
        const lines = (selected || "numbered item")
          .split("\n")
          .map((l, idx) => (l ? `${idx + 1}. ${l}` : l))
          .join("\n");
        replace(lines);
      }
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function goToProfile() {
      if (!currentEmail) {
        window.location.href = "profile.html";
        return;
      }
      window.location.href = "profile.html?email=" + encodeURIComponent(currentEmail);
    }

    function logout() {
      window.location.href = "index.html";
    }
  </script>
</body>
</html>
